define(["require", "exports", "./Map2D", "./TemplateRoom"], function (require, exports, Map2D_1, TemplateRoom_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var defaults = {
        width: 50,
        height: 50,
    };
    function oppositeDirection(dir) {
        switch (dir) {
            case TemplateRoom_1.Direction.TOP: return TemplateRoom_1.Direction.BOTTOM;
            case TemplateRoom_1.Direction.BOTTOM: return TemplateRoom_1.Direction.TOP;
            case TemplateRoom_1.Direction.LEFT: return TemplateRoom_1.Direction.RIGHT;
            case TemplateRoom_1.Direction.RIGHT: return TemplateRoom_1.Direction.LEFT;
        }
    }
    var directions = [TemplateRoom_1.Direction.TOP, TemplateRoom_1.Direction.BOTTOM, TemplateRoom_1.Direction.LEFT, TemplateRoom_1.Direction.RIGHT];
    function addOpenDoor(x, y, room, direction, openDoors) {
        if (room.doorways[direction] < 0)
            return;
        if (direction === TemplateRoom_1.Direction.TOP) {
            openDoors.push({ direction: direction, x: x + room.doorways[direction], y: y });
        }
        else if (direction === TemplateRoom_1.Direction.BOTTOM) {
            openDoors.push({ direction: direction, x: x + room.doorways[direction], y: y + room.height - 1 });
        }
        else if (direction === TemplateRoom_1.Direction.LEFT) {
            openDoors.push({ direction: direction, x: x, y: y + room.doorways[direction] });
        }
        else if (direction === TemplateRoom_1.Direction.RIGHT) {
            openDoors.push({ direction: direction, x: x + room.width - 1, y: y + room.doorways[direction] });
        }
    }
    function addOpenDoors(x, y, room, openDoors, exculde) {
        if (exculde === void 0) { exculde = []; }
        for (var _i = 0, directions_1 = directions; _i < directions_1.length; _i++) {
            var dir = directions_1[_i];
            if (exculde.indexOf(dir) >= 0 || room.doorways[dir] < 0)
                continue;
            addOpenDoor(x, y, room, dir, openDoors);
        }
    }
    function roomCanAttach(direction, candidateRoom) {
        return candidateRoom.doorways[oppositeDirection(direction)] >= 0;
    }
    function connectedRoomXY(door, room) {
        var connectingDoor = room.doorways[oppositeDirection(door.direction)];
        switch (door.direction) {
            case TemplateRoom_1.Direction.TOP: return { x: door.x - connectingDoor, y: door.y - room.height };
            case TemplateRoom_1.Direction.BOTTOM: return { x: door.x - connectingDoor, y: door.y + 1 };
            case TemplateRoom_1.Direction.LEFT: return { x: door.x - room.width, y: door.y - connectingDoor };
            case TemplateRoom_1.Direction.RIGHT: return { x: door.x + 1, y: door.y - connectingDoor };
            default: throw new Error("Invalid direction");
        }
    }
    function DunGen(templates, opts) {
        opts = opts || {};
        for (var _i = 0, _a = Keys(defaults); _i < _a.length; _i++) {
            var key = _a[_i];
            if (opts[key] === undefined)
                opts[key] = defaults[key];
        }
        var dungeon = new Dungeon(opts.width, opts.height);
        var openDoors = [];
        templates = fyShuffle(templates);
        var root = templates[0];
        var x = Math.floor((dungeon.width - root.width) / 2);
        var y = Math.floor((dungeon.height - root.height) / 2);
        if (!dungeon.paint(root, x, y)) {
            return dungeon;
        }
        addOpenDoors(x, y, root, openDoors);
        while (openDoors.length) {
            openDoors = fyShuffle(openDoors);
            var door = openDoors.pop();
            templates = fyShuffle(templates);
            for (var _b = 0, templates_1 = templates; _b < templates_1.length; _b++) {
                var candidate = templates_1[_b];
                if (!roomCanAttach(door.direction, candidate))
                    continue;
                var xy = connectedRoomXY(door, candidate);
                if (dungeon.paint(candidate, xy.x, xy.y)) {
                    addOpenDoors(xy.x, xy.y, candidate, openDoors, [oppositeDirection(door.direction)]);
                }
            }
        }
        dungeon = dungeon.map(function (tile, x, y, dungeon) {
            if (tile === -1 || tile === 1) {
                if (y > 0 && y < dungeon.height - 1) {
                    var top_1 = dungeon.tiles.get(x, y - 1);
                    var bottom = dungeon.tiles.get(x, y + 1);
                    if (((top_1 === TemplateRoom_1.Direction.BOTTOM || top_1 === 0) && (bottom === TemplateRoom_1.Direction.TOP || bottom === 0))
                        && top_1 !== bottom) {
                        return TemplateRoom_1.Direction.BOTTOM;
                    }
                }
                if (x > 0 && x < dungeon.width - 1) {
                    var left = dungeon.tiles.get(x - 1, y);
                    var right = dungeon.tiles.get(x + 1, y);
                    if (((left === TemplateRoom_1.Direction.RIGHT || left === 0) && (right === TemplateRoom_1.Direction.LEFT || right === 0))
                        && left !== right) {
                        return 0;
                    }
                }
            }
            if (directions.indexOf(tile) < 0)
                return tile;
            if (x > 0 && x < dungeon.width - 1 && y > 0 && y < dungeon.height - 1) {
                var xy = { x: 0, y: 0 };
                switch (tile) {
                    case TemplateRoom_1.Direction.TOP:
                        xy.y = -1;
                        break;
                    case TemplateRoom_1.Direction.BOTTOM:
                        xy.y = 1;
                        break;
                    case TemplateRoom_1.Direction.LEFT:
                        xy.x = -1;
                        break;
                    case TemplateRoom_1.Direction.RIGHT:
                        xy.x = 1;
                        break;
                }
                if (dungeon.tiles.get(x + xy.x, y + xy.y) === oppositeDirection(tile)) {
                    return tile === TemplateRoom_1.Direction.BOTTOM ? TemplateRoom_1.Direction.BOTTOM : 0;
                }
                else {
                    if (x > 1 && x < dungeon.width - 2 && y > 1 && y < dungeon.height - 2) {
                        var reach = dungeon.tiles.get(x + xy.x * 2, y + xy.y * 2);
                        if (reach === 0 || reach === oppositeDirection(tile)) {
                            return tile === TemplateRoom_1.Direction.BOTTOM ? TemplateRoom_1.Direction.BOTTOM : 0;
                        }
                    }
                }
            }
            return 1;
        });
        var ladderSeeds = [];
        for (var i = 0; i < dungeon.width - 1; i++) {
            for (var j = 0; j < dungeon.width - 1; j++) {
                if (dungeon.tiles.get(i, j) === 0 && dungeon.tiles.get(i + 1, j) === 0) {
                    var bl = dungeon.tiles.get(i, j + 1);
                    var br = dungeon.tiles.get(i + 1, j + 1);
                    if (bl === 1 && br === TemplateRoom_1.Direction.BOTTOM) {
                        ladderSeeds.push({ x: i + 1, y: j + 1 });
                    }
                    else if (bl === TemplateRoom_1.Direction.BOTTOM && br === 1) {
                        ladderSeeds.push({ x: i, y: j + 1 });
                    }
                }
            }
        }
        ladderSeeds = fyShuffle(ladderSeeds);
        function eraseBottomDoor(x, y) {
            if (dungeon.tiles.get(x, y) === TemplateRoom_1.Direction.BOTTOM) {
                dungeon.tiles.set(x, y, 0);
                eraseBottomDoor(x - 1, y);
                eraseBottomDoor(x + 1, y);
            }
        }
        while (ladderSeeds.length > 0) {
            var seed = ladderSeeds.pop();
            if (dungeon.tiles.get(seed.x, seed.y) !== TemplateRoom_1.Direction.BOTTOM)
                continue;
            while (dungeon.tiles.get(seed.x, seed.y) !== 1) {
                if (dungeon.tiles.get(seed.x, seed.y) === TemplateRoom_1.Direction.BOTTOM) {
                    eraseBottomDoor(seed.x, seed.y);
                }
                dungeon.tiles.set(seed.x, seed.y, 6);
                seed.y++;
            }
        }
        return dungeon;
    }
    exports.DunGen = DunGen;
    var Dungeon = /** @class */ (function () {
        function Dungeon(width, height, initializer) {
            if (initializer === void 0) { initializer = function () { return -1; }; }
            this.width = width;
            this.height = height;
            this.tiles = new Map2D_1.Map2D();
            for (var i = 0; i < width; i++) {
                for (var j = 0; j < height; j++) {
                    this.tiles.set(i, j, initializer(i, j));
                }
            }
        }
        Dungeon.prototype.paint = function (room, x, y) {
            if (x < 0 || y < 0 || x + room.width > this.width || y + room.height > this.height)
                return false;
            for (var i = 0; i < room.width; i++) {
                for (var j = 0; j < room.height; j++) {
                    var tile = this.tiles.get(x + i, y + j);
                    if (tile === undefined || tile !== -1)
                        return false;
                }
            }
            for (var i = 0; i < room.width; i++) {
                for (var j = 0; j < room.height; j++) {
                    this.tiles.set(x + i, y + j, room.tiles.get(i, j));
                }
            }
            return true;
        };
        Dungeon.prototype.map = function (fn) {
            var _this = this;
            return new Dungeon(this.width, this.height, function (x, y) {
                return fn(_this.tiles.get(x, y), x, y, _this);
            });
        };
        return Dungeon;
    }());
    exports.Dungeon = Dungeon;
    function fyShuffle(arr) {
        arr = arr.slice();
        for (var i = arr.length - 1; i > 0; i--) {
            var swp = Math.floor(Math.random() * (i + 1));
            var temp = arr[i];
            arr[i] = arr[swp];
            arr[swp] = temp;
        }
        return arr;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRHVuR2VuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL0R1bkdlbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7SUFRQSxJQUFJLFFBQVEsR0FBZTtRQUN2QixLQUFLLEVBQUUsRUFBRTtRQUNULE1BQU0sRUFBRSxFQUFFO0tBQ2IsQ0FBQTtJQVdELDJCQUEyQixHQUFjO1FBQ3JDLE1BQU0sQ0FBQSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDVCxLQUFLLHdCQUFTLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyx3QkFBUyxDQUFDLE1BQU0sQ0FBQztZQUM1QyxLQUFLLHdCQUFTLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyx3QkFBUyxDQUFDLEdBQUcsQ0FBQztZQUM1QyxLQUFLLHdCQUFTLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyx3QkFBUyxDQUFDLEtBQUssQ0FBQztZQUM1QyxLQUFLLHdCQUFTLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyx3QkFBUyxDQUFDLElBQUksQ0FBQztRQUNoRCxDQUFDO0lBQ0wsQ0FBQztJQUVELElBQU0sVUFBVSxHQUFHLENBQUMsd0JBQVMsQ0FBQyxHQUFHLEVBQUUsd0JBQVMsQ0FBQyxNQUFNLEVBQUUsd0JBQVMsQ0FBQyxJQUFJLEVBQUUsd0JBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUV0RixxQkFBcUIsQ0FBUyxFQUFFLENBQVMsRUFBRSxJQUFrQixFQUFFLFNBQW9CLEVBQUUsU0FBc0I7UUFDdkcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUM7UUFDekMsRUFBRSxDQUFDLENBQUMsU0FBUyxLQUFLLHdCQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUM5QixTQUFTLENBQUMsSUFBSSxDQUFFLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElB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TCxDQUFDO1lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQscUJBQUcsR0FBSCxVQUFJLEVBQWlFO1lBQXJFLGlCQUlDO1lBSEcsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxVQUFDLENBQUMsRUFBRSxDQUFDO2dCQUM3QyxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUksQ0FBQyxDQUFDO1lBQ2hELENBQUMsQ0FBRSxDQUFDO1FBQ1IsQ0FBQztRQUNMLGNBQUM7SUFBRCxDQUFDLEFBL0JELElBK0JDO0lBL0JZLDBCQUFPO0lBaUNwQixtQkFBc0IsR0FBUTtRQUMxQixHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2xCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFHLEVBQUUsQ0FBQztZQUN2QyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlDLElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2xCLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDcEIsQ0FBQztRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWFwMkQgfSBmcm9tIFwiLi9NYXAyRFwiO1xyXG5pbXBvcnQgeyBUZW1wbGF0ZVJvb20sIERpcmVjdGlvbiB9IGZyb20gXCIuL1RlbXBsYXRlUm9vbVwiO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEdW5HZW5PcHRzIHtcclxuICAgIHdpZHRoPzogbnVtYmVyLFxyXG4gICAgaGVpZ2h0PzogbnVtYmVyLFxyXG59XHJcblxyXG5sZXQgZGVmYXVsdHM6IER1bkdlbk9wdHMgPSB7XHJcbiAgICB3aWR0aDogNTAsXHJcbiAgICBoZWlnaHQ6IDUwLFxyXG59XHJcblxyXG5pbnRlcmZhY2UgSU9wZW5Eb29yIGV4dGVuZHMgSVBvaW50IHtcclxuICAgIGRpcmVjdGlvbjogRGlyZWN0aW9uO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVBvaW50IHtcclxuICAgIHg6IG51bWJlcjtcclxuICAgIHk6IG51bWJlcjtcclxufVxyXG5cclxuZnVuY3Rpb24gb3Bwb3NpdGVEaXJlY3Rpb24oZGlyOiBEaXJlY3Rpb24pOiBEaXJlY3Rpb24ge1xyXG4gICAgc3dpdGNoKGRpcikge1xyXG4gICAgICAgIGNhc2UgRGlyZWN0aW9uLlRPUDogcmV0dXJuIERpcmVjdGlvbi5CT1RUT007XHJcbiAgICAgICAgY2FzZSBEaXJlY3Rpb24uQk9UVE9NOiByZXR1cm4gRGlyZWN0aW9uLlRPUDtcclxuICAgICAgICBjYXNlIERpcmVjdGlvbi5MRUZUOiByZXR1cm4gRGlyZWN0aW9uLlJJR0hUO1xyXG4gICAgICAgIGNhc2UgRGlyZWN0aW9uLlJJR0hUOiByZXR1cm4gRGlyZWN0aW9uLkxFRlQ7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IGRpcmVjdGlvbnMgPSBbRGlyZWN0aW9uLlRPUCwgRGlyZWN0aW9uLkJPVFRPTSwgRGlyZWN0aW9uLkxFRlQsIERpcmVjdGlvbi5SSUdIVF07XHJcblxyXG5mdW5jdGlvbiBhZGRPcGVuRG9vcih4OiBudW1iZXIsIHk6IG51bWJlciwgcm9vbTogVGVtcGxhdGVSb29tLCBkaXJlY3Rpb246IERpcmVjdGlvbiwgb3BlbkRvb3JzOiBJT3BlbkRvb3JbXSkge1xyXG4gICAgaWYgKHJvb20uZG9vcndheXNbZGlyZWN0aW9uXSA8IDApIHJldHVybjtcclxuICAgIGlmIChkaXJlY3Rpb24gPT09IERpcmVjdGlvbi5UT1ApIHtcclxuICAgICAgICBvcGVuRG9vcnMucHVzaCggeyBkaXJlY3Rpb246IGRpcmVjdGlvbiwgeDogeCArIHJvb20uZG9vcndheXNbZGlyZWN0aW9uXSwgeTogeSB9ICk7XHJcbiAgICB9IGVsc2UgaWYgKGRpcmVjdGlvbiA9PT0gRGlyZWN0aW9uLkJPVFRPTSkge1xyXG4gICAgICAgIG9wZW5Eb29ycy5wdXNoKCB7IGRpcmVjdGlvbjogZGlyZWN0aW9uLCB4OiB4ICsgcm9vbS5kb29yd2F5c1tkaXJlY3Rpb25dLCB5OiB5ICsgcm9vbS5oZWlnaHQgLSAxIH0gKTtcclxuICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSBEaXJlY3Rpb24uTEVGVCkge1xyXG4gICAgICAgIG9wZW5Eb29ycy5wdXNoKCB7IGRpcmVjdGlvbjogZGlyZWN0aW9uLCB4OiB4LCB5OiB5ICsgcm9vbS5kb29yd2F5c1tkaXJlY3Rpb25dIH0gKTtcclxuICAgIH0gZWxzZSBpZiAoZGlyZWN0aW9uID09PSBEaXJlY3Rpb24uUklHSFQpIHtcclxuICAgICAgICBvcGVuRG9vcnMucHVzaCggeyBkaXJlY3Rpb246IGRpcmVjdGlvbiwgeDogeCArIHJvb20ud2lkdGggLSAxLCB5OiB5ICsgcm9vbS5kb29yd2F5c1tkaXJlY3Rpb25dIH0gKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gYWRkT3BlbkRvb3JzKHg6IG51bWJlciwgeTogbnVtYmVyLCByb29tOiBUZW1wbGF0ZVJvb20sIG9wZW5Eb29yczogSU9wZW5Eb29yW10sIGV4Y3VsZGU6IERpcmVjdGlvbltdID0gW10pIHtcclxuICAgIGZvciAobGV0IGRpciBvZiBkaXJlY3Rpb25zKSB7XHJcbiAgICAgICAgaWYgKGV4Y3VsZGUuaW5kZXhPZihkaXIpID49IDAgfHwgcm9vbS5kb29yd2F5c1tkaXJdIDwgMCkgY29udGludWU7XHJcbiAgICAgICAgYWRkT3BlbkRvb3IoeCwgeSwgcm9vbSwgZGlyLCBvcGVuRG9vcnMpO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByb29tQ2FuQXR0YWNoKGRpcmVjdGlvbjogRGlyZWN0aW9uLCBjYW5kaWRhdGVSb29tOiBUZW1wbGF0ZVJvb20pIHtcclxuICAgIHJldHVybiBjYW5kaWRhdGVSb29tLmRvb3J3YXlzW29wcG9zaXRlRGlyZWN0aW9uKGRpcmVjdGlvbildID49IDA7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbm5lY3RlZFJvb21YWShkb29yOiBJT3BlbkRvb3IsIHJvb206IFRlbXBsYXRlUm9vbSkge1xyXG4gICAgbGV0IGNvbm5lY3RpbmdEb29yID0gcm9vbS5kb29yd2F5c1tvcHBvc2l0ZURpcmVjdGlvbihkb29yLmRpcmVjdGlvbildO1xyXG4gICAgc3dpdGNoIChkb29yLmRpcmVjdGlvbikge1xyXG4gICAgICAgIGNhc2UgRGlyZWN0aW9uLlRPUDogcmV0dXJuIHsgeDogZG9vci54IC0gY29ubmVjdGluZ0Rvb3IsIHk6IGRvb3IueSAtIHJvb20uaGVpZ2h0IH07XHJcbiAgICAgICAgY2FzZSBEaXJlY3Rpb24uQk9UVE9NOiByZXR1cm4geyB4OiBkb29yLnggLSBjb25uZWN0aW5nRG9vciwgeTogZG9vci55ICsgMSB9O1xyXG4gICAgICAgIGNhc2UgRGlyZWN0aW9uLkxFRlQ6IHJldHVybiB7IHg6IGRvb3IueCAtIHJvb20ud2lkdGgsIHk6IGRvb3IueSAtIGNvbm5lY3RpbmdEb29yIH07XHJcbiAgICAgICAgY2FzZSBEaXJlY3Rpb24uUklHSFQ6IHJldHVybiB7IHg6IGRvb3IueCArIDEsIHk6IGRvb3IueSAtIGNvbm5lY3RpbmdEb29yIH07XHJcbiAgICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBkaXJlY3Rpb25cIik7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBEdW5HZW4odGVtcGxhdGVzOiBUZW1wbGF0ZVJvb21bXSwgb3B0cz86IER1bkdlbk9wdHMpIHtcclxuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xyXG4gICAgZm9yIChsZXQga2V5IG9mIEtleXMoZGVmYXVsdHMpKSB7XHJcbiAgICAgICAgaWYgKG9wdHNba2V5XSA9PT0gdW5kZWZpbmVkKSBvcHRzW2tleV0gPSBkZWZhdWx0c1trZXldO1xyXG4gICAgfVxyXG4gICAgbGV0IGR1bmdlb24gPSBuZXcgRHVuZ2VvbihvcHRzLndpZHRoISwgb3B0cy5oZWlnaHQhKTtcclxuICAgIGxldCBvcGVuRG9vcnM6IElPcGVuRG9vcltdID0gW107XHJcbiAgICB0ZW1wbGF0ZXMgPSBmeVNodWZmbGUodGVtcGxhdGVzKTtcclxuICAgIGxldCByb290ID0gdGVtcGxhdGVzWzBdO1xyXG4gICAgbGV0IHggPSBNYXRoLmZsb29yKChkdW5nZW9uLndpZHRoIC0gcm9vdC53aWR0aCkgLyAyKTtcclxuICAgIGxldCB5ID0gTWF0aC5mbG9vcigoZHVuZ2Vvbi5oZWlnaHQgLSByb290LmhlaWdodCkgLyAyKTtcclxuICAgIGlmICghZHVuZ2Vvbi5wYWludChyb290LCB4LCB5KSkge1xyXG4gICAgICAgIHJldHVybiBkdW5nZW9uO1xyXG4gICAgfVxyXG4gICAgYWRkT3BlbkRvb3JzKHgsIHksIHJvb3QsIG9wZW5Eb29ycyk7XHJcblxyXG4gICAgd2hpbGUgKG9wZW5Eb29ycy5sZW5ndGgpIHtcclxuICAgICAgICBvcGVuRG9vcnMgPSBmeVNodWZmbGUob3BlbkRvb3JzKTtcclxuICAgICAgICBsZXQgZG9vciA9IG9wZW5Eb29ycy5wb3AoKSE7XHJcbiAgICAgICAgdGVtcGxhdGVzID0gZnlTaHVmZmxlKHRlbXBsYXRlcyk7XHJcbiAgICAgICAgZm9yIChsZXQgY2FuZGlkYXRlIG9mIHRlbXBsYXRlcykge1xyXG4gICAgICAgICAgICBpZiAoIXJvb21DYW5BdHRhY2goZG9vci5kaXJlY3Rpb24sIGNhbmRpZGF0ZSkpIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICBsZXQgeHkgPSBjb25uZWN0ZWRSb29tWFkoZG9vciwgY2FuZGlkYXRlKTtcclxuICAgICAgICAgICAgaWYgKGR1bmdlb24ucGFpbnQoY2FuZGlkYXRlLCB4eS54LCB4eS55KSkge1xyXG4gICAgICAgICAgICAgICAgYWRkT3BlbkRvb3JzKHh5LngsIHh5LnksIGNhbmRpZGF0ZSwgb3BlbkRvb3JzLCBbb3Bwb3NpdGVEaXJlY3Rpb24oZG9vci5kaXJlY3Rpb24pXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGR1bmdlb24gPSBkdW5nZW9uLm1hcCggKHRpbGUsIHgsIHksIGR1bmdlb24pID0+IHtcclxuICAgICAgICBpZiAodGlsZSA9PT0gLTEgfHwgdGlsZSA9PT0gMSkge1xyXG4gICAgICAgICAgICBpZiAoeSA+IDAgJiYgeSA8IGR1bmdlb24uaGVpZ2h0IC0gMSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHRvcCA9IGR1bmdlb24udGlsZXMuZ2V0KHgsIHkgLSAxKTtcclxuICAgICAgICAgICAgICAgIGxldCBib3R0b20gPSBkdW5nZW9uLnRpbGVzLmdldCh4LCB5ICsgMSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoKCh0b3AgPT09IERpcmVjdGlvbi5CT1RUT00gfHwgdG9wID09PSAwKSAmJiAoYm90dG9tID09PSBEaXJlY3Rpb24uVE9QIHx8IGJvdHRvbSA9PT0gMCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiB0b3AgIT09IGJvdHRvbSlcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gRGlyZWN0aW9uLkJPVFRPTTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoeCA+IDAgJiYgeCA8IGR1bmdlb24ud2lkdGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IGR1bmdlb24udGlsZXMuZ2V0KHggLSAxLCB5KTtcclxuICAgICAgICAgICAgICAgIGxldCByaWdodCA9IGR1bmdlb24udGlsZXMuZ2V0KHggKyAxLCB5KTtcclxuICAgICAgICAgICAgICAgIGlmICgoKGxlZnQgPT09IERpcmVjdGlvbi5SSUdIVCB8fCBsZWZ0ID09PSAwKSAmJiAocmlnaHQgPT09IERpcmVjdGlvbi5MRUZUIHx8IHJpZ2h0ID09PSAwKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBsZWZ0ICE9PSByaWdodClcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZGlyZWN0aW9ucy5pbmRleE9mKHRpbGUpIDwgMCkgcmV0dXJuIHRpbGU7XHJcbiAgICAgICAgaWYgKHggPiAwICYmIHggPCBkdW5nZW9uLndpZHRoIC0gMSAmJiB5ID4gMCAmJiB5IDwgZHVuZ2Vvbi5oZWlnaHQgLSAxKSB7XHJcbiAgICAgICAgICAgIGxldCB4eSA9IHsgeDogMCwgeTogMCB9O1xyXG4gICAgICAgICAgICBzd2l0Y2ggKHRpbGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgRGlyZWN0aW9uLlRPUDogeHkueSA9IC0xOyBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgRGlyZWN0aW9uLkJPVFRPTTogeHkueSA9IDE7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBEaXJlY3Rpb24uTEVGVDogeHkueCA9IC0xOyBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgRGlyZWN0aW9uLlJJR0hUOiB4eS54ID0gMTsgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGR1bmdlb24udGlsZXMuZ2V0KHggKyB4eS54LCB5ICsgeHkueSkgPT09IG9wcG9zaXRlRGlyZWN0aW9uKHRpbGUpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGlsZSA9PT0gRGlyZWN0aW9uLkJPVFRPTSA/IERpcmVjdGlvbi5CT1RUT00gOiAwO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHggPiAxICYmIHggPCBkdW5nZW9uLndpZHRoIC0gMiAmJiB5ID4gMSAmJiB5IDwgZHVuZ2Vvbi5oZWlnaHQgLSAyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlYWNoID0gZHVuZ2Vvbi50aWxlcy5nZXQoeCArIHh5LnggKiAyLCB5ICsgeHkueSAqIDIpXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYWNoID09PSAwIHx8IHJlYWNoID09PSBvcHBvc2l0ZURpcmVjdGlvbih0aWxlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGlsZSA9PT0gRGlyZWN0aW9uLkJPVFRPTSA/IERpcmVjdGlvbi5CT1RUT00gOiAwO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gMTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBsZXQgbGFkZGVyU2VlZHM6IElQb2ludFtdID0gW107XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGR1bmdlb24ud2lkdGggLSAxOyBpICsrKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBkdW5nZW9uLndpZHRoIC0gMTsgaiArKykge1xyXG4gICAgICAgICAgICBpZiAoZHVuZ2Vvbi50aWxlcy5nZXQoaSwgaikgPT09IDAgJiYgZHVuZ2Vvbi50aWxlcy5nZXQoaSArIDEsIGopID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgYmwgPSBkdW5nZW9uLnRpbGVzLmdldChpLCBqICsgMSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgYnIgPSBkdW5nZW9uLnRpbGVzLmdldChpICsgMSwgaiArIDEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGJsID09PSAxICYmIGJyID09PSBEaXJlY3Rpb24uQk9UVE9NKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFkZGVyU2VlZHMucHVzaCh7IHg6IGkgKyAxLCB5OiBqICsgMSB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmwgPT09IERpcmVjdGlvbi5CT1RUT00gJiYgYnIgPT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBsYWRkZXJTZWVkcy5wdXNoKHsgeDogaSwgeTogaiArIDEgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBsYWRkZXJTZWVkcyA9IGZ5U2h1ZmZsZShsYWRkZXJTZWVkcyk7XHJcblxyXG4gICAgZnVuY3Rpb24gZXJhc2VCb3R0b21Eb29yKHg6IG51bWJlciwgeTogbnVtYmVyKSB7XHJcbiAgICAgICAgaWYgKGR1bmdlb24udGlsZXMuZ2V0KHgsIHkpID09PSBEaXJlY3Rpb24uQk9UVE9NKSB7XHJcbiAgICAgICAgICAgIGR1bmdlb24udGlsZXMuc2V0KHgsIHksIDApO1xyXG4gICAgICAgICAgICBlcmFzZUJvdHRvbURvb3IoeCAtIDEsIHkpO1xyXG4gICAgICAgICAgICBlcmFzZUJvdHRvbURvb3IoeCArIDEsIHkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB3aGlsZSAobGFkZGVyU2VlZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGxldCBzZWVkID0gbGFkZGVyU2VlZHMucG9wKCkhO1xyXG4gICAgICAgIGlmIChkdW5nZW9uLnRpbGVzLmdldChzZWVkLngsIHNlZWQueSkgIT09IERpcmVjdGlvbi5CT1RUT00pIGNvbnRpbnVlO1xyXG4gICAgICAgIHdoaWxlIChkdW5nZW9uLnRpbGVzLmdldChzZWVkLngsIHNlZWQueSkgIT09IDEpIHtcclxuICAgICAgICAgICAgaWYgKGR1bmdlb24udGlsZXMuZ2V0KHNlZWQueCwgc2VlZC55KSA9PT0gRGlyZWN0aW9uLkJPVFRPTSkge1xyXG4gICAgICAgICAgICAgICAgZXJhc2VCb3R0b21Eb29yKHNlZWQueCwgc2VlZC55KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkdW5nZW9uLnRpbGVzLnNldChzZWVkLngsIHNlZWQueSwgNik7XHJcbiAgICAgICAgICAgIHNlZWQueSArKztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGR1bmdlb247XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBEdW5nZW9uIHtcclxuICAgIHB1YmxpYyB0aWxlcyA9IG5ldyBNYXAyRDxudW1iZXI+KCk7XHJcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgd2lkdGg6IG51bWJlciwgcHVibGljIGhlaWdodDogbnVtYmVyLCBpbml0aWFsaXplcjogKHg6IG51bWJlciwgeTogbnVtYmVyKSA9PiBudW1iZXIgPSAoKSA9PiAtMSkge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2lkdGg7IGkgKyspIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBoZWlnaHQ7IGogKyspIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudGlsZXMuc2V0KGksIGosIGluaXRpYWxpemVyKGksIGopKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwYWludChyb29tOiBUZW1wbGF0ZVJvb20sIHg6IG51bWJlciwgeTogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKHggPCAwIHx8IHkgPCAwIHx8IHggKyByb29tLndpZHRoID4gdGhpcy53aWR0aCB8fCB5ICsgcm9vbS5oZWlnaHQgPiB0aGlzLmhlaWdodCkgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcm9vbS53aWR0aDsgaSArKykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJvb20uaGVpZ2h0OyBqICsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgdGlsZSA9IHRoaXMudGlsZXMuZ2V0KHggKyBpLCB5ICsgaik7XHJcbiAgICAgICAgICAgICAgICBpZiAodGlsZSA9PT0gdW5kZWZpbmVkIHx8IHRpbGUgIT09IC0xKSByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByb29tLndpZHRoOyBpICsrKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcm9vbS5oZWlnaHQ7IGogKyspIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudGlsZXMuc2V0KHggKyBpLCB5ICsgaiwgcm9vbS50aWxlcy5nZXQoaSwgaikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIG1hcChmbjogKHRpbGU6IG51bWJlciwgeDogbnVtYmVyLCB5OiBudW1iZXIsIGR1bmdlb246IHRoaXMpID0+IG51bWJlcik6IER1bmdlb24ge1xyXG4gICAgICAgIHJldHVybiBuZXcgRHVuZ2Vvbih0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgKHgsIHkpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGZuKHRoaXMudGlsZXMuZ2V0KHgsIHkpLCB4LCB5LCB0aGlzKTtcclxuICAgICAgICB9ICk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZ5U2h1ZmZsZTxUPihhcnI6IFRbXSk6IFRbXSB7XHJcbiAgICBhcnIgPSBhcnIuc2xpY2UoKTtcclxuICAgIGZvciAobGV0IGkgPSBhcnIubGVuZ3RoIC0gMTsgaSA+IDA7IGkgLS0pIHtcclxuICAgICAgICBsZXQgc3dwID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGkgKyAxKSk7XHJcbiAgICAgICAgbGV0IHRlbXAgPSBhcnJbaV07XHJcbiAgICAgICAgYXJyW2ldID0gYXJyW3N3cF07XHJcbiAgICAgICAgYXJyW3N3cF0gPSB0ZW1wO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFycjtcclxufSJdfQ==